package net.satcy.data{	import flash.display.*;	import flash.errors.IllegalOperationError;	import flash.events.*;	import flash.net.URLRequest;	import flash.system.ApplicationDomain;	import flash.system.LoaderContext;	import flash.utils.*;	/*		@author satoshi@rhizomatiks.com		@discription Loader		@see LoadImageEvent.as		@see LoadSwfManager.as	*/		[Event(name="onProgress",type="rzm.LoadImageEvent")]	[Event(name="onComplete",type="rzm.LoadImageEvent")]		public class LoadImage extends EventDispatcher{						private static var instance:LoadImage = null;    	private static var internallyCalled:Boolean = false;				private var url:String;		public var loader:Loader;		private var onComplete:Function;				public function LoadImage(){//////This is Singleton Class			if (internallyCalled) {  				//trace("constructor is called");   				internallyCalled = false;			} else {  				throw new IllegalOperationError ("Use Singleton.getInstance() to get the instance");			}		}				public static function getInstance():LoadImage {			if(LoadImage.instance == null) {  				//trace("instance is being created");  				internallyCalled = true;   				instance = new LoadImage();			}			return instance; 		}				public function loadImage(_t_url:String, fn:Function):void{			url = _t_url;			onComplete = fn;			///////////////////SWFの多重読み込み回避			var lsm:LoadSwfManager = LoadSwfManager.getInstance();						if(lsm.loadedCheck(url) == false){				loader = new Loader();				configureListeners(loader.contentLoaderInfo);				var request:URLRequest = new URLRequest(url);				var loader_context:LoaderContext;				if ( url.indexOf(".swf") != -1 ){					loader_context = new LoaderContext(false, ApplicationDomain.currentDomain);				}else{					loader_context = new LoaderContext(true);				}				loader.load(request, loader_context );								//loader.load(request, new LoaderContext(false) );			}else{				//loader = lsm.getLoadedObject(url);				//var mc:* = loader.content;				//mc.gotoAndPlay(1);				//var interval_temp:uint = setTimeout(appearSWF0, 100);				onComplete();				onComplete = null;			}		}		private function configureListeners(dispatcher:IEventDispatcher):void {            dispatcher.addEventListener(Event.COMPLETE, completeHandler, false, 0, true);            dispatcher.addEventListener(HTTPStatusEvent.HTTP_STATUS, httpStatusHandler, false, 0, true);            dispatcher.addEventListener(Event.INIT, initHandler, false, 0, true);            dispatcher.addEventListener(IOErrorEvent.IO_ERROR, ioErrorHandler, false, 0, true);            dispatcher.addEventListener(Event.OPEN, openHandler, false, 0, true);            dispatcher.addEventListener(ProgressEvent.PROGRESS, progressHandler, false, 0, true);            dispatcher.addEventListener(Event.UNLOAD, unLoadHandler, false, 0, true);        }				private function removeListeners(dispatcher:IEventDispatcher):void {            dispatcher.removeEventListener(Event.COMPLETE, completeHandler);            dispatcher.removeEventListener(HTTPStatusEvent.HTTP_STATUS, httpStatusHandler);            dispatcher.removeEventListener(Event.INIT, initHandler);            dispatcher.removeEventListener(IOErrorEvent.IO_ERROR, ioErrorHandler);            dispatcher.removeEventListener(Event.OPEN, openHandler);            dispatcher.removeEventListener(ProgressEvent.PROGRESS, progressHandler);            dispatcher.removeEventListener(Event.UNLOAD, unLoadHandler);        }		private function completeHandler(event:Event):void {            //trace("completeHandler: " + event.target);						removeListeners(loader.contentLoaderInfo);						///////////////////SWFの多重読み込み回避			//var mc = getChildAt(0);			var lsm:LoadSwfManager = LoadSwfManager.getInstance();			lsm.loadedStore(url, loader);			//			//loader = null;						if ( onComplete != null ) onComplete();			onComplete = null;        }		private function httpStatusHandler(event:HTTPStatusEvent):void {            //trace("httpStatusHandler: " + event);        }        private function initHandler(event:Event):void {            //trace("initHandler: " + event);        }        private function ioErrorHandler(event:IOErrorEvent):void {            trace("ioErrorHandler: " + event);        }        private function openHandler(event:Event):void {            //trace("openHandler: " + event);        }        private function progressHandler(event:ProgressEvent):void {            //trace("progressHandler: bytesLoaded=" + event.bytesLoaded + " bytesTotal=" + event.bytesTotal);			var r:LoadImageEvent = new LoadImageEvent (LoadImageEvent.ON_PROGRESS);			r.percent = Math.floor(event.bytesLoaded/event.bytesTotal*100);			dispatchEvent (r);///イベント送出        }        private function unLoadHandler(event:Event):void {            //trace("unLoadHandler: " + event);        }	}	}